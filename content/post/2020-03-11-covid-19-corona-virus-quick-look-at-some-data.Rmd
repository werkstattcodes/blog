---
title: 'Covid-19/Corona Virus in Austria: Updates on data'
author: Roland
date: '`r format(Sys.Date(), "%Y-%m-%d")`'
slug: covid-19-corona-virus-quick-look-at-some-data
categories: []
tags:
  - Corona virus
  - Google Trends
description: ''
draft: FALSE
---

**Graphs updated on `r format(Sys.Date(), '%A, %d %b %Y')`**

With the COVID epidemic taking a pretty firm grip on our lives, I thought I’ll use this post as a kind of analytic repository regarding the developments in Austria. There are certainly plenty of other, more advanced analyses out there, so see this as a kind of personal attempt to get a grip on the virus and what is happening around us. Hence, as a caveat, this is purely about crunching numbers. I am no epidemiologist, let alone physician who would have any substantive understanding of the matter. Yet, I think looking at ‘the data’ and bearing the above caveat in mind, can be a worthwhile exercise.

I will try to run the code generating this site once a day, so graphs and text will automatically update. If time permits, new analyses will be added. In terms of interpretation, I’ll be rather brief due to lack of time (kids are at home, partner on home office duty…), but I guess most of the graphs are self-explanatory. 

As always, and since this is also a blog about R, you can find the code in the folded sections. If you think there is a glaring error etc., don’t hesitate and let me know (best via Twitter [DM](https://twitter.com/zoowalk){target="_blank"}).


```{r message=FALSE, include=FALSE}
library(gtrendsR)
library(tidytext)
library(tidyverse)
library(ggtext)
library(hrbrthemes)
library(extrafont)
library(paletteer)
loadfonts(device = "win", quiet = T)
library(patchwork)
library(magrittr)
library(ggforce)
library(scales)
library(glue)
library(here)
library(knitr)
library(wbstats)


```


```{r setup, echo = F}
knit_hooks$set(wrap = function(before, options, envir){
  if (before){
    paste0('<', options$wrap, '>')
  } else {
    paste0('</', options$wrap, '>')
  }
})
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dpi = 180, fig.height = 5, fig.width = 7, fig.align = "center")
options(width=180, dplyr.width = 150)

country_color=c("Italy"="lightgreen", "Austria"="yellow", "China"="red")
my_caption <- c("Graph: Roland Schmidt | @zoowalk | <span style='color:black'>**https://werk.statt.codes**</span>")

bgr_color="white"

theme_rs <- function(){
  theme_ipsum_pub() %+replace%
  #hrbrthemes::theme_ipsum_rc() %+replace%
  #hrbrthemes::theme_ipsum_tw()+
  
    theme(panel.grid.minor.y = element_blank(),
          panel.grid.major.x = element_line(linetype="dotted"),
          panel.grid.minor.x = element_line(linetype="dotted"),
          axis.title.x=element_blank(),
          legend.position = "top",
          legend.justification = "left",
          legend.title = element_blank(),
          strip.text = element_text(face="bold", 
                                    hjust=0),
          plot.margin=margin(l=0, t=0.5, b=0.5, unit="cm"),
          plot.background=element_rect(fill=bgr_color, color="transparent"),
          plot.title = element_text(size = 14, 
                                    color="grey20",
                                    hjust=0,
                                    #face="bold", 
                                    margin=margin(b=0.1, unit="cm")),
          plot.title.position = "plot",
          plot.subtitle = element_text(size = 10, 
                                       hjust=0,
                                       margin=margin(b=0.5, unit="cm"),
                                       color = "grey30"),
          plot.caption.position = "plot",
          plot.caption = element_markdown(color = "grey30", 
                                          margin=margin(t=0.5, unit="cm"),
                                          hjust = 1))
}


```

# Getting data on the COVID-19

The data for this analysis is taken from Johns Hopkins COVID-19 data repository, which seems to be one of, if not the most frequently used data source on Covid-19. Have a look at their [site](https://coronavirus.jhu.edu/){target="_blank"} for more details.

<details closed> 
<summary>Click to see code to get data</summary>
Get the raw data from the repository with the `readr` package, clean the names with `janitor`; then flip the data into a long format, and summarize to get country totals (as opposed to amounts for subregions). The `datatable` function from the `DT` package quickly produces a searchable html table.


```{r}
hopkins_link <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv"

df_corona <- readr::read_csv(hopkins_link) %>% 
  janitor::clean_names()

df_corona_long <- df_corona %>% 
  select(-lat, -long) %>% 
  pivot_longer(cols=-c("province_state", "country_region"),
               names_to = "date",
               values_to = "n_obs") %>% 
  mutate(date=str_remove(date, "x") %>% 
           str_replace_all(., "_", "-") %>% 
           lubridate::mdy(.))  

df_corona_long <- df_corona_long %>% 
  group_by(country_region, date) %>% 
  summarise(n_obs=sum(n_obs, na.rm=T)) %>% 
  ungroup()
```
</details>

```{r echo=FALSE}
DT::datatable(df_corona_long)
```

# Austria, Italy, and China

To put the Austrian case somewhat into perspective I contrast its numbers with those of Italy and China. The former is the worrying neighbor, representing a scenario which is within the realm of the possible for Austria. Since the absolute number of confirmed cases are quite different, I scaled the numbers on a log scale (note the labels on the y axis).

<details closed> 
<summary>Click to see code  plot</summary>
```{r}
plots_3countries <- df_corona_long %>% 
  filter(str_detect(country_region, "Austria|Italy|China")) %>% 
  ggplot()+
  labs(title="Convid-19: Confirmed cases - Austria, Italy, China",
       subtitle=glue("Case count as of: ", "<span style='color:white'>
                     {format(max(df_corona_long$date), '%A, %d %b %Y')}</span>", 
                       "; ",
                       "Note that <span style='color:white'>y axis is log-transformed </span>.","\n"),
       caption=c("Data: John's Hopkins  COVID-19 Data Repository (github.com/CSSEGISandData/COVID-19)",
                 "\nGraph: Roland Schmidt | @zoowalk | https:://werk.statt.codes"),
       y="number of confirmed cases")+
  geom_line(aes(x=date,
                y=n_obs,
                color=country_region),
            size=1)+
  geom_text(data=. %>% filter(date==max(df_corona_long$date)),
            aes(x=date,
                y=n_obs*1.7,
                label=paste(country_region, 
                            scales::comma(n_obs)),
                color=country_region,
                hjust=1))+
  scale_x_date(breaks=scales::date_breaks(width="1 month"),
               labels = scales::label_date_short(),
               expand=expansion(mult=c(0, 0.05)))+
  scale_y_log10(labels=scales::label_comma())+
  scale_color_manual(values=country_color)+
  theme_ft_rc()+
  theme(legend.position="none",
        plot.caption = element_text(hjust=c(0, 0)),
        panel.grid.minor.y = element_blank(),
        plot.subtitle = element_markdown(),
        axis.title.x = element_blank())
```
</details>
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE}
plots_3countries
```

In my view, the graph shows quite clearly the staggering dynamic of the virus' spread in Italy. On 20 February, there were only 3 confirmed cases. 10 days later, the number had already risen to 1694 (check the table above for the exact numbers). The graph also shows the flattening curve in China, an indication for the gradual slowdown of the dynamic. As for Austria, the absolute numbers are as of the time of writing still comparably modest, however, there is a clear, steep upward trajectory. 

# Comparing Austria's and Italy's dynamics

```{r message=FALSE, include=FALSE}
threshold_value <- 100
```

To better contrast both countries' dynamics, I'll replace the dates on the x-axis with an index which indicates the number of days which have passed since the virus' outbreak in each country. This raises the question when the disease actually breaks out. What is the adequate starting position to contrast the disease's development? The presence of one single case? Or more? Taking the presence of only one case may easily be a distorting threshold since in one country the presence of one case might have been missed for some time. Consequently, the ensuing dynamic might appear steeper than in a country which did not miss the first case. I assume epidemiologists have clear concepts on this, but for my purpose I start the index from the **day the threshold of `r threshold_value` cases is crossed**. In the cases of Italy and Austria, this threshold was crossed on the following dates:

<details closed> 
<summary>Click to see code to set threshold and create index</summary>
```{r}

df_AT_IT <- df_corona_long %>% 
  filter(str_detect(country_region, "Austria|Italy")) %>% 
  group_by(country_region, date) %>% 
  summarise(n_obs=sum(n_obs, na.rm=T)) %>% 
  group_by(country_region) %>% 
  arrange(date, .by_group=T) %>% 
  mutate(threshold_indicator=case_when(n_obs>threshold_value ~ 1,
                                TRUE ~ 0)) %>% 
  filter(threshold_indicator>0) %>% 
  mutate(day_index=row_number()) 

```
</details>

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
df_AT_IT %>% 
  select(country_region, date) %>% 
  slice(1)
```

<details closed> 
<summary>Click to see code  plot</summary>
To overlap the lines for Austria and Italy, we have to replace the dates of the x-axis with a common index. As a starting point for this index, I chose the day when the number of `r threshold_value`  confirmed cases was crossed for the first time. That's what the first code block does. The second block produces the graph.

```{r}
pl_AT_IT <- df_AT_IT %>% 
  ggplot()+
  geom_vline(xintercept=df_AT_IT %>% 
               filter(country_region=="Austria") %>% 
               pull(day_index) %>% 
               max(),
             color="white")+
  # geom_text(x=df_AT_IT %>% 
  #              filter(country_region=="Austria") %>% 
  #              pull(day_index) %>% 
  #              max(),
  #           label=scales::lable_date(Sys.date()),
  #           color="white",
  #           angle=90,
  #           hjust=0)+
  geom_line(aes(x=day_index,
                y=n_obs,
                color=country_region))+
  geom_point(data=. %>% filter(day_index==max(df_AT_IT$day_index[df_AT_IT$country_region=="Austria"])),
              aes(x=day_index,
                  size=2,
                y=n_obs,
                color=country_region))+
  labs(title="Covid-19: Comparing dynamics in Austria and Italy",
       subtitle=glue("Starting <span style='color:white'>from day when threshold of {threshold_value} cases was crossed </span>.
       Data as of <span style='color:white'>{format(max(df_AT_IT$date), '%A, %d %b %Y')}</span>."),
       caption=c("Data: John's Hopkins  COVID-19 Data Repository (github.com/CSSEGISandData/COVID-19)",
                 "\nGraph: Roland Schmidt | @zoowalk | https:://werk.statt.codes"),
       x=glue("# days since more then {threshold_value} confirmed cases"),
       y="# confirmed cases")+
  scale_x_continuous(limits=c(1, NA),
                     breaks=c(1, seq(0, max(df_AT_IT$day_index), 5)),
                     minor_breaks = NULL)+
  scale_color_manual(values=country_color)+

  geom_text(data=. %>%  filter(day_index==max(df_AT_IT$day_index[df_AT_IT$country_region=="Austria"]) &
                                 country_region=="Austria"),
              aes(x=day_index,
                  y=n_obs,
                  color=country_region,
                  label=paste0("latest # Austria;",
                               day_index, " days after threshold:", "\n",
                               comma(n_obs))),
            nudge_x = 0.5,
            nudge_y= 250,
            check_overlap = T,
            hjust=0,
            show.legend = F)+
  geom_text(data=. %>%  filter(day_index==max(df_AT_IT$day_index[df_AT_IT$country_region=="Austria"])&
                                 country_region=="Italy"),
            aes(x=day_index,
                y=n_obs,
                color=country_region,
                label=paste0("Italy ", format(date, '%d %b'), ";",
                             day_index, " days after threshold:", "\n", comma(n_obs))),
            nudge_x = -0.5,
            nudge_y= 500,
            check_overlap = T,
            hjust=1,
            show.legend = F)+
  geom_text(data=. %>%  filter(date==as.Date(max(df_AT_IT$date)) &
                                 country_region=="Italy"),
            aes(x=day_index,
                y=n_obs,
                color=country_region,
                label=paste0("latest # Italy: ", 
                             comma(n_obs))),
            nudge_x = 0,
            nudge_y= 500,
            check_overlap = T,
            hjust=1,
            show.legend = F)+
  scale_y_continuous(limits=c(10, NA),
                     minor_breaks = NULL,
                     labels=scales::label_comma(),
                     breaks=c(10, seq(1000, 12000, 2500)))+
  theme_ft_rc()+
  theme(legend.position = "none",
        #legend.justification = "left",
        plot.subtitle = element_markdown(),
        plot.caption = element_text(hjust=c(0, 0)),
        legend.title=element_blank())


```
</details>

Overall, the graph below suggests that Austria is on a somewhat slower trajectory than Italy. Contrasting both countries' absolute numbers on the **latest index day (`r scales::comma(df_AT_IT %>% filter(country_region=="Austria") %>% pull(day_index) %>% tail(1))`th day as of `r format(df_AT_IT %>% filter(country_region=="Austria") %>% pull(date) %>% tail(1), "%d %B")`**, Italy featured already **`r scales::comma(df_AT_IT %>% filter(country_region=="Italy" & day_index==max(df_AT_IT$day_index[df_AT_IT$country_region=="Austria"])) %>% pull(n_obs) %>% tail(1))` cases**. In contrast, Austria featured **`r scales::comma(df_AT_IT %>% filter(country_region=="Austria") %>% pull(n_obs) %>% tail(1))`** confirmed cases. 

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE}
pl_AT_IT
```

# Correcting infection numbers for population size

Critically, one may adjust the number of confirmed cases with the population size of the country. The graph below presents the modified result.

<details closed> 
<summary>Click to see code for plot</summary>
I retrieve Italy's and Austria's population data from the World Bank's pertaining database, accessed via the `wbstats` package.
```{r}
pop_data <- wb(indicator = "SP.POP.TOTL", startdate = 2018, enddate = 2018) %>% 
  filter(str_detect(country, "Austria|Italy"))

df_AT_IT <- df_AT_IT %>% 
  left_join(., 
            pop_data %>% select(country, pop.size=value),
            by=c("country_region"="country")) %>% 
  mutate(n_obs_rel=n_obs/(pop.size/100000))  
  
pl_AT_IT_rel <- df_AT_IT %>% 
  ggplot()+
  geom_vline(xintercept=df_AT_IT %>% 
               filter(country_region=="Austria") %>% 
               pull(day_index) %>% 
               max(),
             color="white")+
  geom_line(aes(x=day_index,
                y=n_obs_rel,
                color=country_region))+
  geom_point(data=. %>% filter(day_index==max(df_AT_IT$day_index[df_AT_IT$country_region=="Austria"])),
             aes(x=day_index,
                 size=2,
                 y=n_obs_rel,
                 color=country_region))+
  labs(title="Covid-19: Comparing dynamics in Austria and Italy",
       subtitle=glue("Confirmed cases <span style='color:white'>per 100,000 inhabitants</span>. Starting <span style='color:white'>from day when threshold of {threshold_value} cases was crossed </span>.
       \nData as of <span style='color:white'>{format(max(df_AT_IT$date), '%A, %d %b %Y')}</span>."),
       caption=c("Data: John's Hopkins  COVID-19 Data Repository (github.com/CSSEGISandData/COVID-19)",
                 "\nGraph: Roland Schmidt | @zoowalk | https:://werk.statt.codes"),
       x=glue("# days since more then {threshold_value} confirmed cases"),
       y="# confirmed cases per 100,000 inhabitants")+
  scale_x_continuous(limits=c(1, NA),
                     breaks=c(1, seq(0, max(df_AT_IT$day_index), 5)),
                     minor_breaks = NULL)+
  scale_color_manual(values=country_color)+
  geom_text(data=. %>%  filter(day_index==max(df_AT_IT$day_index[df_AT_IT$country_region=="Austria"]) &
                                 country_region=="Austria"),
            aes(x=day_index,
                y=n_obs_rel,
                color=country_region,
                label=paste0("latest # Austria;",
                             day_index, " days after threshold:", 
                             round(n_obs_rel, 1))),
            nudge_x = 1,
            nudge_y= 2,
            check_overlap = T,
            hjust=1,
            show.legend = F)+
  geom_text(data=. %>%  filter(day_index==max(df_AT_IT$day_index[df_AT_IT$country_region=="Austria"])&
                                 country_region=="Italy"),
            aes(x=day_index,
                y=n_obs_rel,
                color=country_region,
                label=paste0("Italy ", format(date, '%d %b'), ";",
                             day_index, " days after threshold:", 
                             round(n_obs_rel, 1))),
            nudge_x = 0.5,
            nudge_y= 0,
            check_overlap = T,
            hjust=0,
            show.legend = F)+
  geom_text(data=. %>%  filter(date==as.Date(max(df_AT_IT$date)) &
                                 country_region=="Italy"),
            aes(x=day_index,
                y=n_obs_rel,
                color=country_region,
                label=paste0("latest # Italy: ", 
                             round(n_obs_rel, 1))),
            nudge_x = -1,
            check_overlap = T,
            hjust=1,
            show.legend = F)+
  #scale_y_percent(labels = scales::label_percent(accuracy=0.001))+
  scale_y_continuous(minor_breaks = NULL)+
  theme_ft_rc()+
  theme(legend.position = "none",
        #legend.justification = "left",
        plot.subtitle = element_markdown(lineheight = .5),
        plot.caption = element_text(hjust=c(0, 0)),
        legend.title=element_blank())



```
</details>
Correcting for the population size, Austria's trajectory starts to look more worrying. While Italy had **`r scales::comma(df_AT_IT %>% filter(country_region=="Italy" & day_index==max(df_AT_IT$day_index[df_AT_IT$country_region=="Austria"])) %>% pull(n_obs_rel) %>% tail(1))`** persons infected with Covid-19 on the `r scales::comma(df_AT_IT %>% filter(country_region=="Austria") %>% pull(day_index) %>% tail(1))` day of the outbreak (if we take the aforementioned threshold), Austria only a considerably larger figure of **`r scales::comma(df_AT_IT %>% filter(country_region=="Austria") %>% pull(n_obs_rel) %>% tail(1))`.**



```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE}
pl_AT_IT_rel
```


# Absolute number of new infections

Let's contrast the absolute number of newly confirmed infections from day to day.

<details closed> 
<summary>Click to see code</summary> 
```{r}

df_new_infections <- df_AT_IT %>% 
  group_by(country_region) %>% 
  arrange(date, .by_group=T) %>% 
  mutate(new_infections=n_obs-lag(n_obs)) %>% 
  mutate(max_new_infections=max(new_infections, na.rm = T)) %>% 
  filter(threshold_indicator>0) %>% 
  mutate(day_index=row_number()) %>% 
  ggplot()+
  labs(title="Covid-19: Daily number of new confirmed cases in Austria and Italy",
       subtitle=glue("Data as of <span style='color:white'>{format(max(df_AT_IT$date), '%A, %d %b %Y')}</span>."),
       caption=c("Data: John's Hopkins  COVID-19 Data Repository (github.com/CSSEGISandData/COVID-19)",
                 "\nGraph: Roland Schmidt | @zoowalk | https:://werk.statt.codes"),
       y="# of new confirmed cases per day")+
  geom_bar(aes(x=date,
               y=new_infections,
               color=country_region,
               fill=country_region),
           stat="identity")+
  geom_text(data=. %>% filter(day_index %% 2 != 0 ),
            aes(x=date,
                y=max_new_infections*1.1,
                color=country_region,
                label=scales::comma(new_infections,
                                    accuracy=1),
                fill=country_region),
            stat="identity")+
  geom_text(data=. %>% filter(day_index %% 2 == 0 ),
            aes(x=date,
               y=max_new_infections*1.25,
               color=country_region,
                label=scales::comma(new_infections,
                                    accuracy=1),
               fill=country_region),
          stat="identity")+
  facet_wrap(vars(country_region),
             scales="free_y",
             nrow=2)+
  scale_y_continuous(labels=scales::label_comma(accuracy = 1),
                     expand=expansion(mult=c(0, 0.1)))+
  scale_fill_manual(values=country_color)+
  scale_color_manual(values=country_color)+
  scale_x_date(labels=scales::label_date_short(),
               breaks=breaks_width(width = "1 day"))+
  theme_ft_rc()+
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.subtitle = element_markdown(lineheight = .5),
        plot.caption = element_text(hjust=c(0, 0)),
        legend.title=element_blank())




```
</details> 



```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE}
df_new_infections
```

 
# Growth rates 
 
What if we look at the increase in relative terms, as growth rates:
 
<details closed> 
<summary>Click to see code</summary>
```{r}

# growth rates --------------------------------------------------------------

pl_growth <- df_corona_long %>% 
  filter(str_detect(country_region, "Austria|Italy")) %>% 
  mutate(threshold_indicator=case_when(n_obs>threshold_value ~ 1,
                                       TRUE ~ 0)) %>% 
  group_by(country_region) %>% 
  arrange(date, .by_group=T) %>% 
  filter(threshold_indicator>0) %>%
  mutate(day_index=row_number()) %>%
  mutate(n_obs_prior=lag(n_obs)) %>% 
  mutate(change=(n_obs-n_obs_prior)/n_obs_prior) %>% 
  #filter(date>as.Date("2020-03-01")) %>% 
  ungroup() %>% 
  ggplot()+
  labs(title="Covid-19: Daily growth rates in Austria and Italy",
       subtitle=glue("<span style='color:white'>Daily Percentage change of number of confirmed cases</span> compared to previous day.<br>Data as of <span style='color:white'>{format(max(df_AT_IT$date), '%A, %d %b %Y')}</span>."),
       caption=c("Data: John's Hopkins  COVID-19 Data Repository (github.com/CSSEGISandData/COVID-19)",
                 "\nGraph: Roland Schmidt | @zoowalk | https:://werk.statt.codes"),
       x="# days since more then 10 confirmed cases",
       x="date",
       y="% change to previous day")+
  geom_bar(aes(x=date,
               y=change,
               fill=country_region,
               group=country_region,
               color=country_region),
           width = 0.8,
           stat ="identity",
           position=position_dodge(preserve="single"))+
  # geom_text(aes(x=date,
  #               y=change+0.13,
  #               group=country_region,
  #               label=scales::number(change, 
  #                                    scale=100,
  #                                    accuracy=0.1),
  #               color=country_region,
  #               fill=country_region),
  #           position=position_dodge(width=1),
  #           size=3,
  #           hjust=1,
  #           angle= 45)+
  
    geom_text(data=. %>%  filter(country_region=="Italy"),
              aes(x=date,
                y=2.5,
                group=country_region,
                label=scales::number(change, 
                                     scale=100,
                                     accuracy=0.1),
                color=country_region,
                fill=country_region),
            position=position_dodge(width=1),
            size=4,
            hjust=.5)+
      geom_text(data=. %>%  filter(country_region=="Austria"),
              aes(x=date,
                y=2.7,
                group=country_region,
                label=scales::number(change, 
                                     scale=100,
                                     accuracy=0.1),
                color=country_region,
                fill=country_region),
            position=position_dodge(width=1),
            size=4,
            hjust=.5)+
  scale_y_continuous(labels=scales::label_percent(scale=100))+
  scale_fill_manual(values=country_color)+
  scale_color_manual(values=country_color)+
  scale_x_date(labels=scales::label_date_short(),
               minor_breaks = NULL,
               breaks=scales::date_breaks(width="1 day"),
               guide = guide_axis(n.dodge=1))+
  theme_ft_rc()+
  theme(legend.position = "top",
        legend.justification = "left",
        plot.subtitle = element_markdown(lineheight = .5),
        plot.caption = element_text(hjust=c(0, 0)),
        legend.title=element_blank())

 

```
</details>


```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE}
pl_growth
```

# Growth rates synced

<details closed> 
<summary>Click to see code</summary> 
```{r}

# > growth rates on index axis ----------------------------------------------

pl_growth_index <- df_corona_long %>% 
  filter(str_detect(country_region, "Austria|Italy")) %>% 
  mutate(threshold_indicator=case_when(n_obs>threshold_value ~ 1,
                                       TRUE ~ 0)) %>% 
  group_by(country_region) %>% 
  arrange(date, .by_group=T) %>% 
  filter(threshold_indicator>0) %>%
  mutate(day_index=row_number()) %>%
  mutate(n_obs_prior=lag(n_obs)) %>% 
  mutate(change=(n_obs-n_obs_prior)/n_obs_prior) %>% 
  #filter(date>as.Date("2020-03-01")) %>% 
  ungroup() %>% 
  ggplot()+
  labs(title="Covid-19: Daily growth rates in Austria and Italy",
       subtitle=glue("<span style='color:white'>Daily Percentage change of number of confirmed cases</span> compared to previous day.
       <br>Starting <span style='color:white'>from day when threshold of {threshold_value} cases was crossed </span>.
                     <br>Data as of <span style='color:white'>{format(max(df_AT_IT$date), '%A, %d %b %Y')}</span>."),
       caption=c("Data: John's Hopkins  COVID-19 Data Repository (github.com/CSSEGISandData/COVID-19)",
                 "\nGraph: Roland Schmidt | @zoowalk | https:://werk.statt.codes"),
       x="# days since more then 10 confirmed cases",
       x="date",
       y="% change to previous day")+
  geom_bar(aes(x=day_index,
               y=change,
               fill=country_region,
               group=country_region,
               color=country_region),
           width = 0.8,
           stat ="identity",
           position=position_dodge(preserve="single"))+
  # geom_text(aes(x=day_index,
  #               y=change+0.1,
  #               group=country_region,
  #               label=scales::number(change, 
  #                                    scale=100,
  #                                    accuracy=0.1),
  #               color=country_region,
  #               fill=country_region),
  #           position=position_dodge(width=1),
  #           size=3,
  #           angle= 45)+
  
    geom_text(data=. %>%  filter(country_region=="Italy"),
              aes(x=day_index,
                y=2.5,
                group=country_region,
                label=scales::number(change, 
                                     scale=100,
                                     accuracy=0.1),
                color=country_region,
                fill=country_region),
            position=position_dodge(width=1),
            size=4,
            hjust=.5)+
      geom_text(data=. %>%  filter(country_region=="Austria"),
              aes(x=day_index,
                y=2.7,
                group=country_region,
                label=scales::number(change, 
                                     scale=100,
                                     accuracy=0.1),
                color=country_region,
                fill=country_region),
            position=position_dodge(width=1),
            size=4,
            hjust=0)+
  
  scale_y_continuous(labels=scales::label_percent(scale=100))+
  scale_fill_manual(values=country_color)+
  scale_color_manual(values=country_color)+
  # scale_x_date(labels=scales::label_date_short(),
  #              breaks=scales::date_breaks(width="1 day"),
  #              guide = guide_axis(n.dodge=1))+
  theme_ft_rc()+
  theme(legend.position = "top",
        legend.justification = "left",
        plot.subtitle = element_markdown(lineheight = .5),
        plot.caption = element_text(hjust=c(0, 0)),
        legend.title=element_blank())

 



```
</details>

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE}
pl_growth_index
```

# Test Results

The Federal Ministry of Social Affairs, Health and Consumer Protection provides on its site regular updates on Covid-19. These include data on the total number of tests conducted, the total number of positive findings (infections), the number of person diseased, and the number of persons who recovered. You can find this info _[here]( https://www.sozialministerium.at/Informationen-zum-Coronavirus/Neuartiges-Coronavirus-(2019-nCov).html){target=”_blank’}_.
When it comes to the number of tests conducted and the pertaining results, the information is however somewhat limited since it does not indicate how many tests were conducted at each day and what the pertaining results were (the numbers are only the overall totals).

This is somewhat unfortunate since looking at the latest ‘batch’ or ‘wave’ of test results could provide a helpful indication on the disease’s development. E.g. how many percent of the last test batch were positive findings (presence of an infection)? How did this share develop over time? Furthermore, getting an idea of the absolute number of tests undertaken e.g. during a day would be also informative.

The graphs below provide the answer to this question. A few clarifying notes. The bars/numbers are not tests per day, but the number of tests implemented since the Ministry’s preceding publication of the total number of tests.  This can be 24 hrs (15:00 hrs to 15:00 hrs), but doesn’t have to be. Therefore pay attention to the x-axis labels.

To overcome the limitations of the data provided on the Ministry’s website, I made use of the [Wayback Internet Archive](https://archive.org/web/){target="_blank"} and Bob Rudis' convenient [wayback R package](https://github.com/hrbrmstr/wayback){target="_blank"}. The site provides a crawler which takes regular snapshots (‘mementos’) of a site. With these (although sometimes patchy) ‘snapshots’ it becomes possible to retrieve the data contained on the Ministry’s website since the outbreak of the disease. Calculating the differences between the total amounts provided in these snapshots allows me to get the data for each ‘batch’ of test (results). 

<details closed> 
<summary>Click to see code for getting the data</summary> 
```{r eval=FALSE, include=TRUE}
MoH_link <- "https://www.sozialministerium.at/Informationen-zum-Coronavirus/Neuartiges-Coronavirus-(2019-nCov).html"


# get link to archives (mementos) -----------------------------------------
library(wayback
        )
df_archive <- wayback::get_mementos(MoH_link)
df_archive
df_timemap <- get_timemap(df_archive$link[2])
df_timemap

df_archive_links <- df_timemap %>% 
  filter(rel=="memento") %>% 
  pull(link)


# define function to download mementos ------------------------------------

pb <- dplyr::progress_estimated(length(df_archive_links))


fn_wayback <- function(x) {
  
  pb$tick()$print()
  
  x %>% 
    read_html() %>% 
    html_nodes("p.abstract") %>% 
    html_text(., trim=T) %>% 
    enframe(name=NULL,
            value="text")
  
}

# apply function to links to get content of mementos ----------------------

archives <- df_archive_links %>% 
  map_df(., fn_wayback)

```
</details>


```{r include=FALSE}

# load data ---------------------------------------------------------------

# df_combined <- read.csv2(here("blog_data", "Corona", "data_source_consolidated", "df_ministry.csv"))

consolidated_index <- list.files(path=here("blog_data", "Corona", "data_source_consolidated"), full.names = T) %>% 
  file.info() %>% 
  rownames_to_column(., var="filename") %>% 
  mutate_at(vars(contains("time")), as.POSIXct)

li_latest_consolidated <- consolidated_index %>% 
  arrange(mtime) %>% 
  tail(1) %>% 
  pull(filename)

df_combined <- read.csv2(file=li_latest_consolidated) %>% 
  select(text)

```

<details closed> 
<summary>Click to see code for anaylsis</summary> 
```{r}

# clean raw content -------------------------------------------------------

df_combined_clean <- df_combined %>% 
  mutate(text=str_squish(text)) %>% 
  mutate(date=str_extract(text, "[0-9]{1,2}\\.[0-9]{1,2}\\.[0-9]{4},[:space:][0-9]{1,2}\\:[0-9]{1,2}")) %>% 
  mutate(date_t=lubridate::dmy_hm(date)) %>% 
  mutate(date_d=lubridate::as_date(date_t)) %>% 
  mutate(num_tests=str_extract(text, "(?<=Testungen\\:[:space:])[0-9.]*") %>% 
           str_remove(., "\\.") %>% 
           as.numeric) %>% 
  mutate(num_confirmed=str_extract(text, "(?<=(Bestätigte Fälle\\:[:space:]))[0-9.]*") %>% 
           str_remove(., "\\.") %>% 
           as.numeric) %>%  
  mutate(num_recovered=str_extract(text, "(?<=(Genesene Personen\\:[:space:]))[0-9.]*") %>%
           str_remove(., "\\.") %>% 
           as.numeric) %>% 
  mutate(num_death=str_extract(text, "(?<=(Todesfälle\\:[:space:]))[0-9.]*")) %>% 
  mutate_at(vars(contains("num_")), as.numeric) %>% 
  mutate_at(vars(contains("num_")),funs(replace_na(., 0))) %>% 
  mutate(num_healthy=num_tests-num_confirmed)

latest_time <- max(df_combined_clean$date_t)

df_combined_clean_x <- df_combined_clean %>% 
  group_by(date_d) %>% 
  arrange(date_t, .by_group=T) %>% 
  filter(row_number()==n()) %>% 
  ungroup() %>% 
  arrange(date_d) %>% 
  mutate(num_tests_new=num_tests-lag(num_tests),
         num_confirmed_new=num_confirmed-lag(num_confirmed),
         num_healthy_new=num_tests_new-num_confirmed_new,
         rel_confirmed_new=num_confirmed_new/num_tests_new)

archive_long <- df_combined_clean_x %>% 
  select(date_d, date_t, contains("new")) %>% 
  filter(num_confirmed_new>0) %>% 
  pivot_longer(-c(date_d, date_t),names_to="var", values_to="value") 
```
</details>

<details closed> 
<summary>Click to see code for plot</summary> 
```{r pl_test_results_accum}
my_caption=c("Data: Sozialministerium; Internet Archive Wayback Machine\nGraph: Roland Schmidt | @zoowalk | https://werk.statt.codes")

pl_test_results_accum <- df_combined_clean_x %>% 
  select(num_confirmed, num_healthy, date_t, date_d) %>% 
  pivot_longer(cols=-c(date_t, date_d), names_to="var", values_to="value") %>%  
  ggplot()+
  labs(title="Covid-19/Austria: Accumulated number of tests and results",
       # subtitle=str_wrap(glue("Total bar height: Total number of tests since preceding publication of results.", 
       # "<span style='color:red'>Red segment</span>",
       # ": Number of confirmed infections since preceding publication of results. Data as of {format(latest_time, '%A, %d %b %Y - %H:%M hrs')}. "), 
       #                   120),
       subtitle=glue("Data as of {format(latest_time, '%A, %d %b %Y - %H:%M hrs')}. Data for 1 March missing."),
       caption=my_caption)+
  geom_bar(aes(x=date_d,
               y=value,
               fill=var),
           color=NA,
           stat="identity")+
  scale_x_date(labels = scales::label_date_short(),
               breaks = scales::breaks_width(width="1 day"))+
  scale_y_comma()+
  scale_fill_manual(values=c("num_confirmed"="red",
                             "num_healthy"="grey40"),
                    labels=c("num_confirmed"="infection",
                             "num_healthy"="no infection"))+
  theme_ipsum_rc()+
  theme(legend.position="top",
        axis.text.x = element_text(size=9),
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        plot.subtitle = element_markdown(),
        plot.caption=element_text(hjust=c(0), 
                                  color="grey30",
                                  family="Roboto Condensed"),
        legend.justification = "left",
        legend.title=element_blank(),
        legend.margin = margin(r=0, l=0, unit="cm"),
        legend.key.width=unit(0.5, unit="cm"),
        legend.key.height = unit(0.2, unit="cm"))
  
  
```
</details>

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE}
pl_test_results_accum
```

<details closed> 
<summary>Click to see code for plot</summary> 
```{r}

df_p1<- archive_long %>% 
  filter(var %in% c("num_confirmed_new",
                     "num_healthy_new")) %>% 
  group_by(date_t) %>% 
  mutate(day_total=sum(value, na.rm=T)) %>% 
  ungroup() %>% 
  mutate(day_max=max(day_total, na.rm=T)) %>% 
  filter(day_total > 0)

pl_test_results_interval <- df_p1 %>%   
  ggplot()+
  labs(title="Covid-19/Austria: Test results per publication period",
       # subtitle=str_wrap(glue("Total bar height: Total number of tests since preceding publication of results.", 
       # "<span style='color:red'>Red segment</span>",
       # ": Number of confirmed infections since preceding publication of results. Data as of {format(latest_time, '%A, %d %b %Y - %H:%M hrs')}. "), 
       #                   120),
       subtitle=glue("<span style='color:darkorange')'>Total number</span> of tests since preceding publication of results.", "<br><span style='color:red'>Number of confirmed infections</span> ","since preceding publication of results. <br>Data as of {format(latest_time, '%A, %d %b %Y - %H:%M hrs')}. "),
       caption=my_caption)+
  geom_bar(aes(x=date_t,
               y=value,
               fill=var),
           color=NA,
           stat="identity",
           position=position_stack())+
  
  # geom_text(data=. %>% 
  #             filter(var=="num_confirmed_new") %>% 
  #             filter(value>0),
  #           aes(x=date_t+.2,
  #               y=day_max*1.05,
  #               label=round(value, 0)),
  #           size=3,
  #           vjust=0.5,
  #           family="Roboto Condensed",
  #           hjust=1,
#           nudge_y = 50,
#           check_overlap = TRUE,
#           color="red")+

# geom_text(data=. %>% 
#             arrange(date_t) %>% 
#             head(1),
#           aes(x=date_t-1,
#               y=day_max*1.05),
#           label="infection",
#           hjust=0,
#           color="red",
#           nudge_y = 50,
#           size=3,
#           check_overlap = TRUE)+

# geom_text(data=. %>% 
#             filter(var=="num_healthy_new") %>% 
#             filter(value>0),
#           aes(x=date_t+.2,
#               y=day_max*1.1,
#               label=round(value, 0)),
#           size=3,
#           vjust=0.5,
#           nudge_y = 75,
#           hjust=1,
#           check_overlap = TRUE,
#           color="grey30")+
# 

# labels healthy results

geom_text(data=. %>% 
            filter(var=="num_healthy_new") %>% 
            filter(value>0),
          aes(x=date_t,
              y=value,
              label=round(value, 0)),
          size=4,
          angle=90,
          family="Roboto Condensed",
          nudge_y = -10,
          hjust=1,
          check_overlap = TRUE,
          color="white")+
  
  # geom_text(data=. %>% 
  #             arrange(date_t) %>% 
  #             head(1),
  #           aes(x=date_t-1,
  #               y=day_max*1.1),
  #           label="no infection",
  #           size=3,
  #           nudge_y = 75,
  #           hjust=0,
  #           color="grey30",
#           check_overlap = TRUE)+

#label total test numbers since last pub

geom_text(data=. %>%
            select(date_t, day_total, day_max) %>% 
            filter(day_total>0),
          aes(x=date_t+.2,
              y=day_max,
              label=comma(day_total, accuarcy=1)),
          size=4,
          nudge_y = 500,
          vjust=0.5,
          hjust=.5,
          color="darkorange",
          check_overlap = TRUE)+
  
  # geom_text(data=. %>% 
  #             arrange(date_t) %>% 
  #             head(1),
  #           aes(x=date_t-1,
  #               y=day_max*1.15),
  #           label="daily total",
  #           hjust=0,
  #           nudge_y = 100,
  #           nudge_x =-0.5,
  #           size=3,
#           color="grey30",
#           check_overlap = TRUE)+

# label new infections (pos inside bar)

geom_text(data=. %>% 
            filter(var=="num_confirmed_new") %>%
            # filter(value>64) %>% 
            distinct(),
          aes(x=date_t,
              y=day_total,
              label=scales::number(value, accuracy=1)),
          hjust=.5,
          size=4,
          family="Roboto Condensed",
          color="red",
          check_overlap = TRUE,
          nudge_y=150,
          angle=0)+
  
  # label new infections (pos outside bar)
  
  # geom_text(data=. %>% 
  #             filter(var=="num_confirmed_new") %>%
  #             filter(value<65 & value > 0) %>% 
  #             distinct(),
  #           aes(x=date_t,
  #               y=day_total,
  #               label=scales::number(value, accuracy=1)),
  #           hjust=1,
#           size=4,
#           family="Roboto Condensed",
#           color="red",
#           check_overlap = TRUE,
#           angle=90,
#           nudge_y=70)+

scale_y_continuous(expand=expansion(mult=c(0, 0.1)),
                   minor_breaks=NULL,
                   breaks=seq(0, 2000, 500))+
  scale_x_datetime(breaks = df_p1$date_t,
                   labels = date_format("%d/%m\n%Hhrs",
                                        tz = "UTC"))+
  scale_fill_manual(values=c("num_confirmed_new"="red",
                             "num_healthy_new"="grey40"),
                    labels=c("num_confirmed_new"="infection",
                             "num_healthy_new"="no infection"))+
  theme_ipsum_rc()+
  theme(legend.position="top",
        axis.text.x = element_text(size=9),
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        plot.subtitle = element_markdown(color="grey30"),
        plot.caption=element_text(hjust=c(0), 
                                  color="grey30",
                                  family="Roboto Condensed"),
        legend.justification = "left",
        legend.title=element_blank(),
        legend.margin = margin(r=0, l=0, unit="cm"),
        legend.key.width=unit(0.5, unit="cm"),
        legend.key.height = unit(0.2, unit="cm"))

```
</details>

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE}
pl_test_results_interval
```


<details closed> 
<summary>Click to see code</summary>
```{r}

# > p2 --------------------------------------------------------------------

df_p2<- archive_long %>% 
  filter(var %in% c("num_confirmed_new",
                     "num_healthy_new")) %>% 
  group_by(date_d) %>% 
  mutate(day_total=sum(value, na.rm=T)) %>% 
  mutate(day_max=sum(day_total, na.rm=T)) %>% 
  ungroup() %>% 
  filter()

pl_test_results_interval_relative <- df_p2 %>% 
  ggplot()+
  labs(title="Covid-19/Austria: Test results per publication period in %",
       subtitle="Numbers indicate share of confirmed cases among total number tested since last publication.",
       caption=my_caption)+
  geom_bar(aes(x=date_t,
               y=value,
               fill=var),
           stat="identity",
           color=NA,
           position="fill")+
  geom_text(data=archive_long %>% 
              filter(var=="rel_confirmed_new") %>% 
              filter(value>0),
            aes(x=date_t,
                y=.9,
                label=percent(value, 
                              scale=100,
                              accuracy = 0.1)),
            size=4,
            vjust=0.5,
            hjust=0.5,
            nudge_y = -0.02,
            angle=90,
            color="white")+
  scale_y_percent(expand=expansion(mult=c(0, 0.1)))+
  scale_fill_manual(values=c("num_confirmed_new"="red",
                             "num_healthy_new"="grey40"),
                    labels=c("num_confirmed_new"="infection",
                             "num_healthy_new"="no infection"))+
  scale_x_datetime(breaks = df_p2$date_t,
                   labels = scales::label_date(format = c("%d/%m\n%Hhrs"), tz = "UTC"))+
  theme_ipsum_rc()+
  theme(legend.position="top",
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=9),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        plot.subtitle = element_markdown(color="grey30"),
        plot.caption=element_text(hjust=c(0), 
                                  color="grey30",
                                  family="Roboto Condensed"),
        legend.justification = "left",
        legend.title=element_blank(),
        legend.margin = margin(r=0, l=0, unit="cm"),
        legend.text.align = 0,
        legend.box.margin = margin(l=0, unit="cm"),
        legend.key.width=unit(0.5, unit="cm"),
        legend.key.height = unit(0.2, unit="cm"))

```
</details>

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE}
pl_test_results_interval_relative
```
